version: '3.8'

services:
  # === 1. 인프라 (DB & Redis) ===
  dollar-db:
    image: mysql:8.0
    container_name: dollar-db
    ports:
      - "3307:3306"
    environment:
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - TZ=${TZ}
    volumes:
      - db_data:/var/lib/mysql
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - dollar-network

  dollar-redis:
    image: redis:alpine
    container_name: dollar-redis
    ports:
      - "6379:6379"
    networks:
      - dollar-network

  # === 2. 백엔드 마이크로서비스 ===
  dollar-user:
    build: ./dollar-user
    container_name: dollar-user
    expose:
      - "8082"
    environment:
      - RDS_HOST=${RDS_HOST}
      - RDS_USERNAME=${RDS_USERNAME}
      - RDS_PASSWORD=${RDS_PASSWORD}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
    depends_on:
      dollar-db:
        condition: service_healthy
    networks:
      - dollar-network

  dollar-product:
    build: ./dollar-product
    container_name: dollar-product
    expose:
      - "8083"
    environment:
      - RDS_HOST=${RDS_HOST}
      - RDS_USERNAME=${RDS_USERNAME}
      - RDS_PASSWORD=${RDS_PASSWORD}
      - REDIS_HOST=dollar-redis
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - ACCESS_KEY_ID=${ACCESS_KEY_ID}
      - AWS_SECRET_KEY=${AWS_SECRET_KEY}
      - PRODUCT_BUCKET_NAME=${PRODUCT_BUCKET_NAME}
      - LOAD_USER=${LOAD_USER}
      - LOAD_ORDER=${LOAD_ORDER}
      - STORAGE_LOCAL_BASE_PATH=${STORAGE_LOCAL_BASE_PATH}
      - STORAGE_MODE=${STORAGE_MODE}
      # Used to build public image URLs when STORAGE_MODE=local (Nginx on 8080)
      - APP_BASE_URL=${PRODUCT_PUBLIC_BASE_URL}
    volumes:
      - ./uploads:/data/uploads
    depends_on:
      dollar-user:
        condition: service_started
    networks:
      - dollar-network

  dollar-order:
    build: ./dollar-order
    container_name: dollar-order
    expose:
      - "8084"
    environment:
      - RDS_HOST=${RDS_HOST}
      - RDS_USERNAME=${RDS_USERNAME}
      - RDS_PASSWORD=${RDS_PASSWORD}
      - REDIS_HOST=dollar-redis
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - KAKAO_API_ADMIN_KEY=${KAKAO_API_ADMIN_KEY}
      # External public base URL for redirects (override in .env on server)
      - ORDER_PUBLIC_BASE_URL=${ORDER_PUBLIC_BASE_URL}
      - ACCESS_KEY_ID=${ACCESS_KEY_ID}
      - AWS_SECRET_KEY=${AWS_SECRET_KEY}
      - LOAD_USER=${LOAD_USER}
      - LOAD_PRODUCT=${LOAD_PRODUCT}
    depends_on:
      dollar-product:
        condition: service_started
    networks:
      - dollar-network

  dollar-review:
    build: ./dollar-review
    container_name: dollar-review
    expose:
      - "8085"
    environment:
      - RDS_HOST=${RDS_HOST}
      - RDS_USERNAME=${RDS_USERNAME}
      - RDS_PASSWORD=${RDS_PASSWORD}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - ACCESS_KEY_ID=${ACCESS_KEY_ID}
      - AWS_SECRET_KEY=${AWS_SECRET_KEY}
      - REVIEW_BUCKET_NAME=${REVIEW_BUCKET_NAME}
      - LOAD_PRODUCT=${LOAD_PRODUCT}
      - LOAD_ORDER=${LOAD_ORDER}
    networks:
      - dollar-network
    depends_on:
      dollar-db:
        condition: service_healthy

  # === 3. 프론트엔드 (웹 서버) ===
  dollar-front:
    build: ./dollar-front
    container_name: dollar-front
    expose:
      - "8081"
    networks:
      - dollar-network

  # === 4. Nginx Reverse Proxy ===
  nginx:
    image: nginx:alpine
    container_name: dollar-nginx
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - dollar-front
      - dollar-user
      - dollar-product
      - dollar-order
      - dollar-review
    ports:
      - "8080:80"
    networks:
      - dollar-network

networks:
  dollar-network:
    driver: bridge

volumes:
  db_data:
