<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/css/common.css">
  <link rel="stylesheet" href="/css/orderComplete.css">
  <title>주문 내역</title>
  <style>
    /* 페이지 전용 비주얼 보강 (기능 영향 없음) */
    .page-head { display:flex; align-items:flex-end; justify-content:space-between; gap:16px; padding:24px 0 12px; }
    .page-head h2 { margin:0; }
    #orderList > div { background: var(--color-surface); border:1px solid var(--color-border); border-radius: var(--radius-md); padding:16px; box-shadow: var(--shadow-sm); margin-bottom:12px; }
    .orderDetail { display:none; background:#fafafa; border:1px dashed var(--color-border); border-radius: var(--radius-sm); padding:12px; margin-top:10px; }
    .orderDetail p { margin: 6px 0; }
  </style>
</head>

<body>
  <header class="site-header">
    <div class="header-container">
      <div class="brand-group">
        <a class="logo" href="/" aria-label="메인으로 이동">
          <img src="/images/logo.gif" alt="텐트릴리언달러 로고" />
          <span>tentrilliondollars</span>
        </a>
        <a class="home-link" href="/" aria-label="홈으로 이동">Home</a>
      </div>

      <form id="searchForm" action="/index.html" method="get" role="search" aria-label="상품 검색">
        <input type="text" id="searchBox" name="search" placeholder="상품 검색..." autocomplete="off" />
        <button type="submit" aria-label="검색" id="searchBtn">검색</button>
      </form>

      <div class="actions">
        <div class="icons" aria-label="빠른 작업">
          <button type="button" id="basket" class="icon-button" aria-label="장바구니">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M6 6h15l-1.5 9h-12L6 6zm0 0L5 3H2" stroke="currentColor" stroke-width="1.7" fill="none" stroke-linecap="round" stroke-linejoin="round" />
              <circle cx="9" cy="20" r="1.5" fill="currentColor" />
              <circle cx="18" cy="20" r="1.5" fill="currentColor" />
            </svg>
          </button>
          <button type="button" id="myPage" class="icon-button" aria-label="마이페이지">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <circle cx="12" cy="8" r="3.5" stroke="currentColor" stroke-width="1.7" fill="none" />
              <path d="M5 20c0-3.5 3-6 7-6s7 2.5 7 6" stroke="currentColor" stroke-width="1.7" fill="none" stroke-linecap="round" />
            </svg>
          </button>
        </div>
        <div id="authButtons" aria-live="polite" aria-atomic="true"></div>
      </div>
    </div>
  </header>
  <main class="container">
    <section class="page-head" aria-label="주문 안내">
      <h2>주문 내역</h2>
    </section>
    <div id="orderList" class="section surface"></div>
  </main>

  <script src="/js/env.js"></script>
  <script>
  const order_url = API.ORDER;



  document.addEventListener('DOMContentLoaded', function() {
    fetchOrderList(); // 주문 목록을 가져오는 함수 호출
  });

  function fetchOrderList() {
    fetch(order_url + 'order/userorder', {
      method: 'GET',
      credentials: 'include', // 쿠키 포함
      headers: {
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(orderList => {
      const orderListContainer = document.getElementById('orderList');
      orderList.forEach(order => {
        const orderElement = document.createElement('div');
        orderElement.innerHTML = `
            <p>주문 ID: <span class="orderId" data-orderId="${order.orderId}">${order.orderId}</span></p>
            <p>주문 상태: ${order.state}</p>
            <p>배송 주소: ${order.fullAddress}</p>
            ${order.state === 'NOTPAYED' ? '<button class="payBtn" data-orderId="' + order.orderId + '">결제하기</button>' : ''}
            ${order.state === 'PREPARING' ? '<button class="cancelBtn" data-orderId="' + order.orderId + '">결제 취소</button>' : ''}

            <button class="showDetailBtn" data-orderId="${order.orderId}">상세보기</button> <!-- 상세보기 버튼 추가 -->
            <div class="orderDetail" id="orderDetail_${order.orderId}"> <!-- 상세 내용을 감싸는 div -->
              <!-- 여기에 상세 내용이 들어갈 부분 -->
            </div>
            <hr>
          `;
        orderListContainer.appendChild(orderElement);
      });
    })
    .catch(error => console.error('Error fetching order list:', error));
  }

  document.addEventListener('click', function(event) {
    if (event.target.classList.contains('showDetailBtn')) {
      const orderId = event.target.getAttribute('data-orderId');
      const orderDetail = document.getElementById(`orderDetail_${orderId}`);
      toggleOrderDetail(orderDetail, orderId);
    } else if (event.target.classList.contains('payBtn')) {
      const orderId = event.target.getAttribute('data-orderId');
      payForOrder(orderId);
    } else if (event.target.classList.contains('cancelBtn')) {
      const orderId = event.target.getAttribute('data-orderId');
      cancelOrder(orderId);
    }
  });

  function cancelOrder(orderId) {
    // 취소 작업을 수행하는 fetch 호출
    fetch(order_url + `payment/cancel/` + orderId, {
      method: 'GET',
      credentials: 'include', // 쿠키 포함
      headers: {
        'Content-Type': 'application/json'
      }
    })
    .then(response => {
      if (response.ok) {
        alert('결제가 취소되었습니다.');
        // 새로고침하여 변경된 상태 반영
        window.location.reload();
      } else {
        throw new Error('결제 취소에 실패했습니다. HTTP 상태 코드: ' + response.status);
      }
    })
    .catch(error => alert('결제 취소 중 오류 발생: ' + error.message));
  }

  function toggleOrderDetail(orderDetail, orderId) {
    if (orderDetail.style.display === 'none') {
      fetchOrderDetail(orderId, orderDetail);
      orderDetail.style.display = 'block';
    } else {
      orderDetail.style.display = 'none';
    }
  }

  function fetchOrderDetail(orderId, orderDetail) {
    // 주문 상세 정보를 가져오는 fetch 호출
    fetch(order_url + `order/${orderId}`, {
      method: 'GET',
      credentials: 'include', // 쿠키 포함
      headers: {
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(orderDetailData => {
      if (orderDetailData && orderDetailData.length > 0) {
        let productDetails = '';
        orderDetailData.forEach(product => {
          productDetails += `
          <p>상품 ID: ${product.productId}</p>
          <p>상품 이름: ${product.productName}</p>
          <p>수량: ${product.quantity}</p>
          <p>단가: ${product.price}</p>
          <p>총 가격: ${product.totalPrice}</p>
          <hr>
        `;
        });
        orderDetail.innerHTML = productDetails;
      } else {
        orderDetail.innerHTML = '<p>주문 상세 정보를 가져올 수 없습니다.</p>';
      }
    })
    .catch(error => console.error(`Error fetching order detail for orderId ${orderId}:`, error));
  }

  function payForOrder(orderId) {
    // 결제하기 fetch 호출
    fetch(order_url + `payment/ready/` + orderId, {
      method: 'GET',
      credentials: 'include', // 쿠키 포함
      headers: {
        'Content-Type': 'application/json'
      }
    })
    .then(response => {
      if (response.ok) {
        alert('결제 페이지로 이동합니다.');
        return response.json();
      } else {
        throw new Error('결제에 실패했습니다. HTTP 상태 코드: ' + response.status);
      }
    })
    .then(data => {
      // 현재 페이지를 비활성화
      document.body.style.pointerEvents = 'none';

      // 새 창 열기 시도
      let newWindow = window.open(data.next_redirect_pc_url, '_blank');

      // 새 창이 열리지 않았을 때의 처리
      if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
        // 현재 페이지 활성화
        document.body.style.pointerEvents = 'auto';
        console.log('새 창을 열 수 없습니다.');
        return;
      }

      // 새 창이 닫힐 때까지 대기
      let interval = setInterval(() => {
        if (newWindow.closed) {
          clearInterval(interval);
          // 현재 페이지 활성화
          document.body.style.pointerEvents = 'auto';
          // 새로고침
          window.location.reload();
        }
      }, 1000); // 매 초마다 새 창이 닫혔는지 확인
    })
  .catch(error => alert('주문 결제 중 오류 발생: ' + error.message));
  }
  </script>
  <script src="js/common.js"></script>
</body>

</html>
