<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/css/common.css">
  <link rel="stylesheet" href="/css/cart.css">
  <title>장바구니</title>
  <style>
    /* 페이지 전용 비주얼 보강 (기능 영향 없음) */
    .page-head { display:flex; align-items:flex-end; justify-content:space-between; gap:16px; padding:24px 0 12px; }
    .page-head h2 { margin:0; }
    #cartItems { display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:16px; padding-top:12px; }
    #cartItems > div { background: var(--color-surface); border:1px solid var(--color-border); border-radius: var(--radius-md); padding:16px; box-shadow: var(--shadow-sm); display:flex; flex-direction:column; gap:6px; }
    #cartItems img { width:100%; height:180px; object-fit:cover; border-radius: var(--radius-sm); }
    #addressSelect { margin: 12px 0; padding: 10px 12px; border-radius: var(--radius-sm); border:1px solid var(--color-border); background: #fff; }
    #totalPrice { font-weight:700; margin: 8px 0 12px; }
    #placeOrderBtn { align-self: flex-start; }
    /* 수량 컨트롤을 작고 가로 배치로 */
    .qty-row { display:inline-flex; align-items:center; gap:8px; }
    .qty-row .quantity { min-width: 28px; text-align:center; font-weight:700; }
    .qty-btn { padding: 4px 10px; border-radius: 999px; background: var(--color-bg); border:1px solid var(--color-border); color: var(--color-text); box-shadow: var(--shadow-sm); line-height: 1; }
    .qty-btn:hover { background: var(--color-border); }
  </style>
</head>

<body>
  <header class="site-header">
    <div class="header-container">
      <div class="brand-group">
        <a class="logo" href="/" aria-label="메인으로 이동">
          <img src="/images/logo.gif" alt="텐트릴리언달러 로고" />
          <span>tentrilliondollars</span>
        </a>
        <a class="home-link" href="/" aria-label="홈으로 이동">Home</a>
      </div>

      <form id="searchForm" action="/index.html" method="get" role="search" aria-label="상품 검색">
        <input type="text" id="searchBox" name="search" placeholder="상품 검색..." autocomplete="off" />
        <button type="submit" aria-label="검색" id="searchBtn">검색</button>
      </form>

      <div class="actions">
        <div class="icons" aria-label="빠른 작업">
          <button type="button" id="basket" class="icon-button" aria-label="장바구니">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M6 6h15l-1.5 9h-12L6 6zm0 0L5 3H2" stroke="currentColor" stroke-width="1.7" fill="none" stroke-linecap="round" stroke-linejoin="round" />
              <circle cx="9" cy="20" r="1.5" fill="currentColor" />
              <circle cx="18" cy="20" r="1.5" fill="currentColor" />
            </svg>
          </button>
          <button type="button" id="myPage" class="icon-button" aria-label="마이페이지">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <circle cx="12" cy="8" r="3.5" stroke="currentColor" stroke-width="1.7" fill="none" />
              <path d="M5 20c0-3.5 3-6 7-6s7 2.5 7 6" stroke="currentColor" stroke-width="1.7" fill="none" stroke-linecap="round" />
            </svg>
          </button>
        </div>
        <div id="authButtons" aria-live="polite" aria-atomic="true"></div>
      </div>
    </div>
  </header>
  <main class="container">
    <section class="page-head" aria-label="장바구니 안내">
      <h2>장바구니</h2>
    </section>
    <div id="cartItems" class="section surface"></div>
    <select id="addressSelect">
      <option value="">배송 주소를 선택해주세요</option>
    </select>
    <p id="totalPrice">총 가격: 0원</p>
    <button id="placeOrderBtn">주문하기</button>
  </main>


  <script src="/js/env.js"></script>
  <script>
    const user_url = API.USER;
    const order_url = API.ORDER;

    document.addEventListener('DOMContentLoaded', function () {
      displayCartItems();

      fetchAddresses(); // 배송 주소 목록을 가져오는 함수 호출

      document.getElementById('addressSelect').addEventListener('change', function () {
        const selectedAddressId = this.value; // 선택된 주소의 ID를 가져옴
        console.log(selectedAddressId); // 주소 ID를 콘솔에 출력하여 확인
      });


      document.getElementById('placeOrderBtn').addEventListener('click', function () {
        const selectedAddressId = document.getElementById('addressSelect').value;
        console.log(selectedAddressId);
        if (checkTokenExists() && selectedAddressId) {
          placeOrder(selectedAddressId); // 선택된 주소 ID를 주문 함수에 전달
        } else {
          alert('로그인과 배송 주소 선택이 필요합니다.');
          // 필요에 따라 추가 조치
        }
      });
    });


    function displayCartItems() {
      const cartItems = JSON.parse(sessionStorage.getItem('cart')) || [];
      let total = 0;
      const cartItemsContainer = document.getElementById('cartItems');
      cartItemsContainer.innerHTML = '';

      cartItems.forEach((item, index) => {
        const itemElement = document.createElement('div');
        itemElement.innerHTML = `
          <img src="${item.imageUrl}" alt="${item.name}">
          <p class="name">${item.name}</p>
          <p class="price">가격: ${item.price}원</p>
          <p class="qty-row">
            <span>수량:</span>
            <button class="qty-btn" onclick="updateQuantity(${index}, -1)" aria-label="수량 감소">−</button>
            <span class="quantity" data-index="${index}">${item.quantity}</span>
            <button class="qty-btn" onclick="updateQuantity(${index}, 1)" aria-label="수량 증가">+</button>
          </p>
          <p class="sum">합계: <span class="total">${item.price * item.quantity}</span>원</p>
        `;
        cartItemsContainer.appendChild(itemElement);

        total += item.price * item.quantity;
      });

      document.getElementById('totalPrice').textContent = `총 가격: ${total}원`;
    }


    function checkTokenExists() {
      const cookies = document.cookie.split(';');
      return cookies.some(cookie => cookie.trim().startsWith('Authorization='));
    }

    function placeOrder(addressId) {
      const cartItems = JSON.parse(sessionStorage.getItem('cart')) || [];
      // 장바구니 아이템을 basket 형태로 변환
      let basket = {};
      cartItems.forEach(item => {
        basket[item.productId] = item.quantity;
      });

      // 서버에 전송할 요청 본문 구성
      const orderRequest = {
        basket: basket,
        addressId: addressId
      };

      console.log(orderRequest);

      // 서버에 주문 요청을 보내는 fetch API 호출
      fetch(order_url + 'order', {
        method: 'POST',
        credentials: 'include', // 쿠키 포함
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(orderRequest) // 요청 본문에 주문 정보 포함
      })
        .then(response => {
          if (!response.ok) {
            throw new Error('주문 처리 실패, 상품수량 확인 혹은 관리자에게 문의해주세요');
          }
          return response.json();
        })
        .then(data => {
          // 여기에 들어오면

          alert('주문이 생성되었습니다. 주문 내역에서 결제를 부탁드립니다.\n\n5분 내에 결제를 안 할 시에 주문이 취소됩니다.');
          // 주문 완료 후 로컬 스토리지에서 장바구니 정보 삭제
          sessionStorage.removeItem('cart');
          // 주문 완료 페이지나 메인 페이지로 리다이렉션
          window.location.href = 'orderComplete.html'; // 이 부분은 적절한 주문 완료 페이지로 변경해주세요.
        })
        .catch(error => {
          console.error('Order error:', error);
          alert('주문 처리 중 오류가 발생했습니다.');
        });
    }


    function updateQuantity(index, change) {
      const cartItems = JSON.parse(sessionStorage.getItem('cart')) || [];
      if (index >= 0 && index < cartItems.length) {
        // 수량 변경
        cartItems[index].quantity += change;

        // 수량이 1 미만이 되면 해당 상품 삭제
        if (cartItems[index].quantity < 1) {
          cartItems.splice(index, 1);
        }

        // 변경된 장바구니 정보를 로컬 스토리지에 저장
        sessionStorage.setItem('cart', JSON.stringify(cartItems));

        // 장바구니 UI를 업데이트
        displayCartItems();
      }
    }

    function fetchAddresses() {
      // 주소 목록을 가져오는 서버의 엔드포인트 예시: '/api/addresses'
      fetch(user_url + 'users/address', {
        method: 'GET',
        credentials: 'include', // 쿠키 포함
        headers: {
          'Content-Type': 'application/json'
        }
      })
        .then(response => response.json())
        .then(addresses => {
          const selectElement = document.getElementById('addressSelect');
          addresses.forEach(address => {
            // 주소 객체에서 도시, 읍/면/동, 도 정보를 조합하여 전체 주소를 생성
            const fullAddress = `${address.city} ${address.village} ${address.province}`;
            console.log(fullAddress);
            const optionElement = document.createElement('option');
            optionElement.value = address.id;
            optionElement.textContent = fullAddress; // 전체 주소를 옵션의 텍스트로 설정
            selectElement.appendChild(optionElement);
          });
        })
        .catch(error => console.error('Error fetching addresses:', error));
    }
  </script>
  <script src="/js/common.js"></script>
</body>

</html>
