<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/css/common.css" />
  <link rel="stylesheet" href="/css/loginSignup.css" />
  <title>회원가입 및 로그인</title>
  <style>
    /* 페이지 전용 비주얼 보강 (기능 영향 없음) */
    .auth-wrapper {
      max-width: 960px;
      margin: 40px auto;
      padding: 0 20px;
    }
    .auth-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 32px;
    }
    .auth-card header {
      margin-bottom: 16px;
    }
    .auth-card header h2 {
      margin: 0 0 8px 0;
      text-align: left;
    }
    .auth-card header p {
      margin: 0;
      color: var(--color-muted);
      font-size: 0.9rem;
    }
    @media (min-width: 860px) {
      .auth-grid { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>

<body>
  <div id="header-placeholder"></div>

  <main class="auth-wrapper" role="main">
    <div class="auth-grid">
      <section class="section surface auth-card" aria-labelledby="signup-title">
        <header>
          <h2 id="signup-title">회원가입</h2>
          <p>이메일과 비밀번호를 입력해 계정을 생성하세요.</p>
        </header>
        <!-- 기능 호환: form/필드/ID/버튼 그대로 유지 -->
        <form id="signupForm" autocomplete="on">
          <label for="signupEmail">이메일</label>
          <input type="email" id="signupEmail" name="email" placeholder="you@example.com" required />

          <label for="signupUsername">사용자 이름</label>
          <input type="text" id="signupUsername" name="username" placeholder="닉네임" required />

          <label for="signupPassword">비밀번호</label>
          <input type="password" id="signupPassword" name="password" placeholder="8자 이상" required />

          <!-- 관리자 옵션 (주석 유지) -->
          <!--
          <input type="checkbox" id="adminCheckbox" name="admin" />
          <label for="adminCheckbox">Admin 권한 부여</label>
          <label for="adminToken">Admin 토큰</label>
          <input type="text" id="adminToken" name="adminToken" />
          -->

          <button type="button" onclick="submitSignupForm()" aria-label="회원가입 제출">가입하기</button>
        </form>
      </section>

      <section class="section surface auth-card" aria-labelledby="login-title">
        <header>
          <h2 id="login-title">로그인</h2>
          <p>등록한 이메일과 비밀번호로 로그인하세요.</p>
        </header>
        <!-- 기능 호환: form/필드/ID/버튼 그대로 유지 -->
        <form id="loginForm" autocomplete="on">
          <label for="loginEmail">이메일</label>
          <input type="email" id="loginEmail" name="email" placeholder="you@example.com" required />

          <label for="loginPassword">비밀번호</label>
          <input type="password" id="loginPassword" name="password" placeholder="비밀번호" required />

          <button type="button" onclick="submitLoginForm()" aria-label="로그인 제출">로그인하기</button>
        </form>
      </section>
    </div>
  </main>

  <script src="/js/env.js"></script>
  <script>
    const user_url = API.USER;

    function submitSignupForm() {
      const email = document.getElementById('signupEmail').value;
      const username = document.getElementById('signupUsername').value;
      const password = document.getElementById('signupPassword').value;
      // const admin = document.getElementById('adminCheckbox').checked;
      // const adminToken = document.getElementById('adminToken').value;
      const admin = false;
      const adminToken = '';

      const data = {
        email: email,
        username: username,
        password: password,
        admin: admin,
        adminToken: adminToken
      };

      fetch(user_url + 'users/signup', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
        .then(response => {
          if (!response.ok) {
            throw new Error(`Network response was not ok, status: ${response.status}`);
          }
          return response.text();
        })
        .then(data => {
          console.log(data);
          alert('회원가입이 완료되었습니다.');
          window.location.reload(); // 페이지 새로고침
        })
        .catch(error => {
          console.error('There has been a problem with your fetch operation:', error);
          alert('회원가입에 실패하였습니다. 아이디는 이메일 형식, 비밀번호는 8자 이상 작성해주세요');
        });
    }

    function submitLoginForm() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      const data = {
        email: email,
        password: password
      };

      fetch(user_url + 'users/login', {
        method: 'POST',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
        .then(response => {
          if (!response.ok) {
            throw new Error(`Network response was not ok, status: ${response.status}`);
          }
          // 서버에서 노출한 Authorization 헤더를 읽어 프론트용 쿠키로 저장 (UI 판별용)
          const token = response.headers.get('Authorization');
          if (token) {
            // Bearer 토큰을 안전하게 인코딩하여 저장
            document.cookie = `Authorization=${encodeURIComponent(token)}; path=/; SameSite=Lax`;
          }
          return response.text(); // JSON이 아닌 텍스트로 응답을 처리
        })
        .then(text => {
          console.log(text);
          alert(text);
          window.location.href = "index.html";
        })
        .catch(error => {
          console.error('Login failed:', error);
          alert('로그인에 실패하였습니다.');
        });

    }
  </script>
  <script defer src="/js/common.js?v=2025-12-13-1"></script>
</body>

</html>
